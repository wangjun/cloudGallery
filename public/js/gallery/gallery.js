"use strict";lcApp.controller("galleryCtr",["$scope","$http","$compile",function(a,b,c){var d=$("#upload-input"),e=$("#images"),f=$("#remove-image-button"),g=$("#show-image-modal"),h=$(".main-gallery"),i="http://cdn.lazycoffee.com";a.images=[],a.duplicateImages=[];var j=e.masonry({itemSelector:".card",percentPosition:!1});j.imagesLoaded().progress(function(){j.masonry("layout")}),h.flickity({pageDots:!1,percentPosition:!1,imagesLoaded:!0,setGallerySize:!1,lazyLoad:2});var k=function(a,b){this.file=a||null,this.$dom=b||null,this.removeUrl="/gallery/remove-image",this.getUpTokenUrl="/cdn/uptoken",this.uploadUrl="http://upload.qiniu.com"};k.prototype.upload=function(){var a=this;a.getOrientation(function(){a.showImage(function(){a.getUpToken(function(){a.uploadImage(function(){a.saveImageInDatabase()})})})})},k.prototype.getOrientation=function(b){var c=this;loadImage.parseMetaData(c.file,function(a){var d=a.exif.getAll(),e=a.exif.get("Orientation");e?(c.orientation=e,c.exif=d,b()):console.log("this is not a photo.")}),a.images.unshift({fileName:c.file.name})},k.prototype.showImage=function(a){var b=this;loadImage(b.file,function(c){$("#no-image-gallery").remove();var d=moment(b.exif.DateTime,"YYYY:MM:DD HH:mm:ss").format("LL"),e=$("<div/>");e.addClass("card uploading").append('<div class="image"></div>').append('<div class="content"><div class="meta"><span class="date">'+d+"</span></div></div>").append('<div class="ui bottom attached progress active" data-percent="1"><div class="bar" style="width:1px;"></div></div>'),e.find(".image").append(c),j.prepend(e).masonry("prepended",e),b.$preview=e,a()},{orientation:b.orientation,maxWidth:260,maxHeight:500,canvas:!0})},k.prototype.uploadImage=function(a){var b=this,c=new XMLHttpRequest,d=new FormData;c.open("POST",b.uploadUrl,!0),c.upload.onprogress=function(a){var c=Math.ceil(a.loaded/a.total*100);b.$preview.find(".bar").css({width:c+"%"}).parent().attr("data-percent",c)},c.onreadystatechange=function(){4===c.readyState&&200===c.status&&(b.uploadResponse=JSON.parse(c.response),b.$preview.attr("data-hash",b.uploadResponse.hash).attr("id","image-"+b.uploadResponse.hash).attr("data-name",b.file.name),b.$preview.find(".progress").removeClass("active yellow").addClass("blue"),a())},d.append("token",b.upToken),d.append("file",b.file),c.send(d)},k.prototype.getUpToken=function(a){var b=this;$.get(b.getUpTokenUrl,function(c,d){"success"===d?(b.upToken=c.uptoken,a()):console.error("获取上传Token时发生网络错误。")})},k.prototype.saveImageInDatabase=function(){var c=this,d={};d.hash=c.uploadResponse.hash,d.key=c.uploadResponse.key,d.galleryId=a.galleryId,d.fileName=c.file.name,d.date=c.exif.DateTime,b.post("/image/save",d).then(function(b){console.log(b);var d=b.data;if("OK"===b.statusText){if(5===d.state){a.duplicateImages.push(c.file.name);for(var e=0;e<a.images.length;e++)a.images[e].fileName===c.file.name&&(a.images[e].hash||a.images.splice(e,1));console.log(a.images),console.log(a.duplicateImages),j.masonry("remove",c.$preview).masonry("layout")}else if(-1===[2,4].indexOf(d.state))window.alertModal("抱歉，服务器发生错误，保存不了你的图片...");else{c.$preview.find(".progress").addClass("success"),h.flickity("prepend",$('<img data-flickity-lazyload="'+i+"/"+c.uploadResponse.key+'_w900"/>'));for(var f=0;f<a.images.length;f++)a.images[f].fileName===c.file.name&&(a.images[f].hash||(a.images[f].hash=c.uploadResponse.hash,a.images[f].key=c.uploadResponse.key))}c.$preview.removeClass("uploading")}else console.error("Sorry,保存相册到数据库的时候出现网络错误了..."),j.masonry("remove",c.$preview).masonry("layout")})},k.prototype.removeItem=function(a,c,d){var e=this,f=d||function(){};a&&c?e.getUpToken(function(){b.post(e.removeUrl,{hash:a,galleryId:c}).then(function(a){var b=a.data;console.log(b),"OK"===a.statusText?f(b):console.error("删除照片时发生网络错误，这种情况一般源于网络传输故障，与本站无关，请与你的网络服务商联系。")})}):console.log("error:hash"+a+";gallery:"+c)},e.on("click",".card",function(){var b=$(this).attr("data-hash"),c=[];a.images.forEach(function(a){a.hash&&c.push(a.hash)});var d=c.indexOf(b);a.currentImage=a.images[d],h.flickity("select",d),$(this).hasClass("uploading")?window.alertModal("上传中，请耐心等待..."):g.modal({onVisible:function(){h.flickity("resize")}}).modal("show"),a.$apply()}),a.initImages=function(b){a.images.push(b)},a.selectFiles=function(){d.trigger("click"),a.duplicateImages=[]},f.on("click",function(){var b=[1,2,4,5,7],c=new k,d=[];f.addClass("loading"),a.images.forEach(function(a){a.hash&&d.push(a.hash)});var e=d.indexOf(a.currentImage.hash);return-1===e?!1:void c.removeItem(a.currentImage.hash,a.galleryId,function(c){-1===b.indexOf(c.state)?f.popup({content:"删除失败",on:"focus"}).popup("show"):(j.masonry("remove",$("#image-"+a.currentImage.hash)).masonry("layout"),a.images.splice(e,1),a.images.length===e+1?a.currentImage=a.images[0]:a.currentImage=a.images[e+1],console.log(a.currentImage),h.flickity("remove",$("#flickity-"+a.currentImage.hash)),f.popup("destroy")),f.removeClass("loading")})}),d.on("change",function(){for(var a=this.files,b=0;b<a.length;b++){var c=a[b],d=new k(c,e);d.upload()}}),$("#hide-image-modal").on("click",function(a){a.preventDefault(),g.modal("hide")}),g.modal({onHidden:function(){f.removeClass("loading disabled"),f.html("删除")}}),$("#weibo-share-btn").on("click",function(a){a.preventDefault(),$.post("/society/weibo/share",{content:"testing"},function(a,b){"success"===b&&(4===a.state&&window.alertModal("你尚未登录。"),console.log(a))})})}]);